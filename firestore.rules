/**
 * Core Philosophy: This ruleset enforces a strict, user-centric security model. 
 * A user has complete control over their own profile and associated rental data,
 * but is completely isolated from other users' data. Publicly browsable content,
 * like vehicle listings, is read-only for all clients, with modifications
 * assumed to be handled by a trusted backend service.
 *
 * Data Structure: The structure clearly separates private and public data.
 * All user-specific data is nested under `/users/{userId}`, creating a private data
 * tree for each user. Publicly readable data, such as `/vehicles`, exists as a
 * top-level collection.
 *
 * Key Security Decisions:
 * - User Isolation: Users can only read and write data within their own
 *   `/users/{userId}` path. Listing or accessing other users' data is prohibited.
 * - Public Read, Secure Writes: The `/vehicles` collection is public for anyone
 *   to read, facilitating browsing within the app. However, all client-side
 *   write operations are disabled to prevent unauthorized modifications.
 * - Backend-Only Data: Sensitive data, such as the `/gps_data` subcollection,
 *   is completely inaccessible to all client-side users, ensuring that it can
 *   only be managed by server-side processes with admin privileges.
 *
 * Denormalization for Authorization: The `Rental` documents under
 * `/users/{userId}/rentals/{rentalId}` contain a denormalized `userId` field.
 * These rules enforce that this internal `userId` must match the `userId` in the
 * document path, ensuring relational integrity and simple, fast ownership checks
 * without requiring extra database reads.
 *
 * Structural Segregation: Private rental data is segregated into a subcollection
 * under the user (`/users/{userId}/rentals`). This is more secure and performant
 * for querying than storing all rentals in a single top-level collection with
 * owner ID flags, as it allows for secure list operations based on the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    // ------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the fundamental check for resource ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner and the document already exists.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user's ID is correctly set on a new document.
     * Ensures relational integrity between the path and document content on create.
     */
    function isLinkedToOwnerOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Enforces immutability of the user ID field on update.
     * Prevents re-assigning a document to a different user.
     */
    function ownerLinkIsImmutable() {
      return request.resource.data.id == resource.data.id;
    }
    
    /**
     * Validates that the rental's userId field matches the owner's path.
     * Ensures new rentals are correctly associated with their owner.
     */
    function rentalIsLinkedToOwnerOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Enforces immutability of the rental's userId field on update.
     * Prevents re-assigning a rental to a different user.
     */
    function rentalOwnerLinkIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }


    // Collection Rules
    // ------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow A signed-in user (auth.uid: 'user123') can (create) their own profile at /users/user123.
     * @deny An authenticated user (auth.uid: 'user123') cannot (get) another user's profile at /users/user456.
     * @principle Enforces strict data ownership. A user's profile can only be created and managed by that user.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isLinkedToOwnerOnCreate(userId);
      allow update: if isExistingOwner(userId) && ownerLinkIsImmutable();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages rental bookings for a specific user.
       * @path /users/{userId}/rentals/{rentalId}
       * @allow A signed-in user (auth.uid: 'user123') can (create) a new rental document within their own subcollection at /users/user123/rentals/rental_abc.
       * @deny A signed-in user (auth.uid: 'user123') cannot (list) rentals for another user at /users/user456/rentals.
       * @principle Inherits ownership from the parent user document, restricting all access to the data owner.
       */
      match /rentals/{rentalId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && rentalIsLinkedToOwnerOnCreate(userId);
        allow update: if isExistingOwner(userId) && rentalOwnerLinkIsImmutable();
        allow delete: if isExistingOwner(userId);
      }
    }

    /**
     * @description Manages vehicle data, which is public for browsing.
     * @path /vehicles/{vehicleId}
     * @allow Any user, even unauthenticated, can (get) or (list) vehicle documents.
     * @deny Any user, even signed-in, cannot (create), (update), or (delete) a vehicle document.
     * @principle Provides public read access for application content while locking down all client-side writes, deferring modifications to a trusted backend process.
     */
    match /vehicles/{vehicleId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn(); 
      allow update: if isSignedIn(); 
      allow delete: if isSignedIn();

      /**
       * @description Secures sensitive GPS data for a vehicle.
       * @path /vehicles/{vehicleId}/gps_data/{gpsDataId}
       * @allow No client-side request is permitted.
       * @deny A signed-in user (auth.uid: 'user123') cannot (get) GPS data at /vehicles/vehicle_abc/gps_data/gps_point_1.
       * @principle Enforces a strict "backend-only" access model for sensitive or internal data collections. All client access is denied.
       */
      match /gps_data/{gpsDataId} {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }
  }
}
